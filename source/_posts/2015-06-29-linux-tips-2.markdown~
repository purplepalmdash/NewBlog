---
layout: post
title: "Linux Tips(2)"
date: 2015-06-29 09:27:17 +0800
comments: true
categories: Linux
---
### 1. XenCenter Installation
Just use your windows's browser point to your XenServer IP Address, Download the XenCenter, and install it.     

Update Some tools on XenServer:    

```
$ vim /etc/yum.repos.d/CentOS-Base.repo
...
enabled=1
...
$ yum install -y lm_sensors
```
After installation of lm_sensors you could see more detailed information on XenServer.     

### 2. Disable Specified Repository
Since citrix have no data in its repository, simply disable it.   

```
$ yum update --disablerepo=citrix
```

### 3. Yum Shell

```
yum shell
remove ffmpeg-libpostproc
remove ffmpeg
install ffmpeg-compat
run
```

### 4. Install lm_sensors In XenServer
The default lm_sensors could not be insalled due to dependency errors, so we download the source code from lm_sensors website and manually build and install it:    

```
$ wget http://dl.lm-sensors.org/lm-sensors/releases/lm_sensors-3.4.0.tar.bz2
$ tar xzvf lm_sensors-3.4.0.tar.bz2
$ cd lm_sensors
$ yum install -y gcc make flex bison 
$ make && make install
$ export PATH=/usr/local/bin:$PATH
$ sensors-detect
$ sensors
```

In 79 machine, sensors won't printout cpu fan, solved by:    

```
$ modprobe it87 force_id=0x8728
```

Or configure the modprobe.d:    

```
[root:/etc/modprobe.d]# cat it87.conf 
options it87 force_id=0x8603

[root:/etc/modprobe.d]# pwd
/etc/modprobe.d
```

### 5. Detect an AMD Chipset
First using `sensors-detect` for detecting the sensors, the result is listed as:    

```
Now follows a summary of the probes I have just done.

Driver `w83627ehf':
  * ISA bus, address 0x290
    Chip `Nuvoton W83677HG-I (NCT5572D/NCT6771F/NCT6772F/NCT6775F) Super IO Sensors' (confidence: 9)

Driver `k10temp' (autoloaded):
  * Chip `AMD Family 12h and 14h thermal sensors' (confidence: 9)
```

Now go to the modules directory for finding out the corresponding driver:    

```
[root@xenserver-WolfHunter 3.10.0+2]# find . | grep -i w83
./kernel/drivers/hwmon/w83795.ko
./kernel/drivers/hwmon/w83627hf.ko
./kernel/drivers/hwmon/w83l786ng.ko
./kernel/drivers/hwmon/w83792d.ko
./kernel/drivers/hwmon/w83l785ts.ko
./kernel/drivers/hwmon/w83791d.ko
./kernel/drivers/hwmon/w83793.ko
./kernel/drivers/hwmon/w83781d.ko
./kernel/drivers/hwmon/w83627ehf.ko
[root@xenserver-WolfHunter 3.10.0+2]# pwd
/lib/modules/3.10.0+2
[root@xenserver-WolfHunter 3.10.0+2]# modprobe w83627ehf.ko
```

Now you could detect more infos, add to automatically:    

```
[root@xenserver-WolfHunter modprobe.d]# cat w83627ehf.conf
#!/bin/sh 
/sbin/insmod /lib/modules/3.10.0+2/kernel/drivers/hwmon/w83627ehf.ko
```

### 6. Headless Ubuntu
Headless Ubuntu, for updating grub.    

```
Add: GRUB_RECORDFAIL_TIMEOUT = 15 in /etc/default/grub, and run "sudo update-grub". You can change the 15 to any arbitrary number of seconds that you like.
```
### 7.Joggler Bootloader Configuration
Notice there are 2 systems available on Joggler.    

```
[dash@/run/media/dash/linux-boot]$ cat grub.cfg
loadfont /unicode.pf2
terminal_output gfxterm
set timeout=5
menuentry "Ubuntu 12.04 LTS (Precise) - 3.2.32joggler1" {
  # text mode
  #linux /vmlinuz-3.2.32joggler1 root=LABEL=linux-root 3 ro text pci=routeirq
  # Graphical mode
  linux /vmlinuz-3.2.32joggler1 root=LABEL=linux-root 3 ro pci=routeirq
  initrd /initrd.img-3.2.32joggler1
}
###############Xubuntu#####################3
#menuentry "XUbuntu 12.04 LTS (Precise) - 3.2.32joggler1" {
#  linux /vmlinuz-3.2.32joggler1 root=LABEL=Xubuntu ro quiet splash 
#  initrd /initrd.img-3.2.32joggler1
}
```

### 8. Use Joggler As a DigitalFrame

```
#!/bin/sh
#
# Script to run Digital Picture Frame using Feh
# drware@thewares.net
#

# Change number below to the duration, in seconds
# for each photo to be displayed
DELAY="5"

# hide the cursor after 15 seconds
#/usr/bin/unclutter -idle 15 &

# Start slide show
# /usr/bin/feh --quiet --recursive --randomize --full-screen \ --slideshow-delay $DELAY /home/dash/800480/
/usr/bin/feh --hide-pointer -D $DELAY --quiet --recursive --randomize --full-screen \ --slideshow-delay $DELAY /home/dash/800480 &

# Phone home and sync
# /home/dsl/frame/rsync.sh

exit 0
```

### 9. Resolving git conflicts
Once you installed meld or other tools, using following commands.    

```
$ git mergetool
```

### 10. Enlarge Volume
Enlarge the qemu disk via:    

```
$ sudo qemu-img resize abc.qcow2 +200GB
```
Enlarge the disk via following command:    

```
[root@fuel ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/mapper/os-root   9.6G  976M  8.1G  11% /
/dev/mapper/os-var     27G  5.4G   20G  22% /var
[root@fuel ~]# lvs
  LV           VG   Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root         os   -wi-ao----  9.78g                                                    
  swap         os   -wi-ao----  2.94g                                                    
  var          os   -wi-ao---- 26.66g       
 
```
Use gparted livecd for enlarge the disk, now you could enjoy the whole 300GiB disk size.    

Resize the var partition:    

```
Disk /dev/mapper/os-var: 28.6 GB, 28621930496 bytes
255 heads, 63 sectors/track, 3479 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
[root@fuel ~]# lvextend -L+50G /dev/mapper/os-var
  Size of logical volume os/var changed from 26.66 GiB (853 extents) to 76.66 GiB (2453 extents).
  Logical volume var successfully resized
######Reboot to gdisk iso, and resize2fs.   
# resize2fs /dev/mapper/os-var
```

###  11. gpg Generation

```
$ apt-get install -y rng-tools
$ rngd -r /dev/urandom
$ gpg --gen-key
$ gpg --list-secret-keys
$ gpg-agent --homedir /home/dash/.gnupg --use-standard-socket --daemon
$ sudo apt-get install gnupg
```

### 12. Syslogd related
Redirect bash script's output to syslogd:     
[http://urbanautomaton.com/blog/2014/09/09/redirecting-bash-script-output-to-syslog/](http://urbanautomaton.com/blog/2014/09/09/redirecting-bash-script-output-to-syslog/)    

Then limit the syslogd activity:    

via logrotate, syslogd don't care about the log file size.   

```
So in the end the top portion of my /etc/logrotate.conf file looks like this:

size 250M
rotate 2
create
#compress
include /etc/logrotate.d
```

### 13. Brake

```
http://www.miroslavnovak.com/qemu-brake_en.php
```

### 14. install specified pip version

```
$ sudo pip install "PyOpenSSL>=0.13"
```

### 15. Tips for using vFense


```
   57  sudo pip install "PyOpenSSL>=0.13"
   58  apt-cache search libffi
   59  sudo apt-get install -y libffi-dev
dash@fenseServer:~$ sudo mkdir /usr/share/rethinkdb

```

### 16. Cgroup error

```

cloudstack4.5.1 在centos7.1 上的 bug 
此bug 会导致 系统vm state 状态获取不到
在agent的log中获取到的错误信息为
Controller 'cpuacct' is not wanted, but 'cpu' is co-mounted: Invalid argument

解决方法

注释这个文件中的这行 /usr/lib64/python2.7/site-packages/cloudutils/serviceConfig.py
cfo.addEntry("cgroup_controllers", "[\"cpu\"]")
和这个文件中的这行 /etc/libvirt/qemu.conf
cgroup_controllers=["cpu"]
重启libvirtd服务

官网bug连接：https://issues.apache.org/jira/browse/CLOUDSTACK-8443
```


### 17. PXE Boot Debian:


```
Install:   
http://backreference.org/2013/12/23/diskless-iscsi-boot-with-pxe-howto/
iscsi:    
http://www.sysprobs.com/guide-how-to-create-iscsi-storage-disks-freenas-08
Trouble Shooting: Use the latest version!!!
https://www.howtoforge.com/community/threads/debian-boot-over-iscsi-problem.67536/#post-321516
iscsi and kvm:
https://www.berrange.com/posts/2010/05/05/provisioning-kvm-virtual-machines-on-iscsi-the-hard-way-part-2-of-2/
```

### 18. Quickly Connect to RDP

```
# ssh -L 2333:10.0.0.2:3389 192.168.10.187 -l root
# rdesktop -u YourUseName -p YourPassword localhost:2333 -g 1400x800
```

### 18. nginx enable directory displaying and follow links:    
On CentOS 7, do following:    

```
$ sudo vim /etc/nginx/nginx.conf
http {
        disable_symlinks off;
}

server {
        root         /var/www/html;

        location / {
                        autoindex on;
        }
```
Restart the nginx service now you could get the local directory avaiable in browser.   


### 20. Get Back the passwd

In Grub, add `single` at the `linux   /boot/vmlinuz-`......   

Press F10, and now you can do whatever you want to do.    

### 21. Enable Nested KVM

```
# virsh edit VM_NAME
<vcpu placement='static' cpuset='0-3'>4</vcpu>
Also change the cpu model.  
<cpu>
....
</cpu> 
remove the tsc related item.   
```

### 22. Restart Windows Under CMD
Specify the timeout(5 seconds) under the cmd line:    

```
# shutdown /r /t 5
```

### 23. Cleanup Windows7 Disk 
Right click the disk, and select ` Disk Cleanup`, then select `Clean up system files`, then your winsxs directory will be cleaned, thus saved your partition volumn.  

### 24. vim spell checking

```
: set spell spelllang=en_us
```

### 25. Startup Synergy At System Startup

```
# vim /etc/lightdm/lightdm.conf
greeter-setup-script=/usr/bin/synergys --config /home/dash/mysynergy.conf
```

### 26. Install Cobbler On Ubuntu

```
# wget -qO - http://download.opensuse.org/repositories/home:/libertas-ict:/cobbler26/xUbuntu_14.04/Release.key | sudo apt-key add -
OK
# sudo add-apt-repository "deb http://download.opensuse.org/repositories/home:/libertas-ict:/cobbler26/xUbuntu_14.04/ ./"
# apt-get update
```


### 27. Install restricted extra packages
Install it via:   

```
 # sudo apt-get install ubuntu-restricted-extras
```

### 28. View Allocated DHCP Address

```
$ more /var/lib/dhcpd/dhcpd.leases
```

### 29. apt-mirror for launchpad
The steps are the same as the ordinary repository.    

```
# vim  /etc/apt/mirror.list
 deb http://ppa.launchpad.net/landscape/15.01/ubuntu trusty main
# apt-mirror
```

### 30. Specify architecture of sources.list
Only include amd64:    

```
$ sudo vim /etc/apt.sources.list
deb [arch=amd64] http://192.168.0.79/landscape/15.01/ubuntu/ trusty main
```

### 31. Use Cobbler Repository

```
[root@localhost yum.repos.d]# cat cobbler.repo 
[core-0]
name=core-0
baseurl=http://10.9.10.1/ks_mirror/CentOS-6.5-x86_64
enabled=1
gpgcheck=0
priority=1
```


### 32. Jenkins Worktips
Worktips:   

```
# visudo
jenkins ALL=(ALL) NOPASSWD:ALL
```

### 33. Query packages

```
$ yum whatprovides "*/mkpasswd"
-or-
$ repoquery -q --file */mkpasswd
```

### 34. Encrypt kickstart used passwd

```
# perl -e "print crypt('engine123','sa')"
saWbOtynpFXBA%
```

### 35. Disable ssh -X warning
Problem: 

```
Couldn't connect to accessibility bus: Failed to connect to socket /tmp/dbus-*
```

Solution:   

```
# vim ~/.bashrc
export NO_AT_BRIDGE=1
```

### 36. Manually add gpg key

```
# wget http://download.opensuse.org/repositories/home:/libertas-ict:/cobbler26/xUbuntu_15.04/Release.key
# cat Release.key |sudo apt-key add -

```
